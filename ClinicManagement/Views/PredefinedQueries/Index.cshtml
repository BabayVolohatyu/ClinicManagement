@model Dictionary<string, ClinicManagement.Services.QueryDefinition>
@{
    ViewData["Title"] = "Predefined Queries";
}

<div class="row justify-content-center">
    <div class="col-lg-10 col-md-12">
        <h2 class="mb-4">Predefined Queries</h2>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-list-check"></i> Execute Predefined Query
                </h5>
            </div>
            <div class="card-body">
                @{
                    var queryKey = Context.Request.Query["queryKey"].ToString();
                    var parameters = Context.Request.Query["parameters"].ToArray();
                    string preFilledQueryKey = string.Empty;
                    string[] preFilledParameters = Array.Empty<string>();
                    
                    if (!string.IsNullOrEmpty(queryKey))
                    {
                        preFilledQueryKey = queryKey;
                        preFilledParameters = parameters ?? Array.Empty<string>();
                    }
                }

                @if (Model.ContainsKey(preFilledQueryKey))
                {
                    var queryDef = Model[preFilledQueryKey];
                    <div class="mb-3">
                        <h6>@queryDef.Name</h6>
                        <p class="text-muted">@queryDef.Description</p>
                    </div>
                    
                    @if (queryDef.RequiresParameters && (preFilledParameters == null || preFilledParameters.Length == 0))
                    {
                        <!-- Parameter Form -->
                        <form id="parameterForm">
                            <div id="parameterFields">
                                @for (int i = 0; i < (queryDef.ParameterLabels?.Length ?? 0); i++)
                                {
                                    <div class="mb-3">
                                        <label for="param-@i" class="form-label">@queryDef.ParameterLabels[i]</label>
                                        @{
                                            var label = queryDef.ParameterLabels[i].ToLower();
                                            if (label.Contains("id") || label.Contains("number"))
                                            {
                                                <input type="number" class="form-control" id="param-@i" name="param-@i" required min="1" />
                                            }
                                            else if (label.Contains("date"))
                                            {
                                                <input type="date" class="form-control" id="param-@i" name="param-@i" required />
                                            }
                                            else
                                            {
                                                <input type="text" class="form-control" id="param-@i" name="param-@i" required />
                                            }
                                        }
                                    </div>
                                }
                            </div>
                            <button type="button" class="btn btn-primary" onclick="executePredefinedQuery('@preFilledQueryKey')">
                                <i class="bi bi-play-fill"></i> Execute Query
                            </button>
                        </form>
                    }
                    else
                    {
                        <!-- Execute Button -->
                        <button type="button" class="btn btn-primary" onclick="executePredefinedQuery('@preFilledQueryKey', @Html.Raw(Json.Serialize(preFilledParameters)))">
                            <i class="bi bi-play-fill"></i> Execute Query
                        </button>
                    }
                }
                else if (!string.IsNullOrEmpty(preFilledQueryKey))
                {
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> Query key '@preFilledQueryKey' not found.
                    </div>
                }
                else
                {
                    <p class="text-muted">Select a predefined query from the list below or from the home page.</p>
                }

                <!-- Results Panel -->
                <div id="resultsPanel" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-table"></i> Results
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="resultsContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Available Queries List -->
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul"></i> Available Predefined Queries
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    @foreach (var kvp in Model)
                    {
                        <div class="col-md-6 col-lg-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">@kvp.Value.Name</h6>
                                    <p class="card-text text-muted small">@kvp.Value.Description</p>
                                    @if (kvp.Value.RequiresParameters)
                                    {
                                        <small class="text-info"><i class="bi bi-info-circle"></i> Requires parameters</small>
                                    }
                                    <div class="mt-2">
                                        <a href="@Url.Action("Index", "PredefinedQueries", new { queryKey = kvp.Key })" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-arrow-right"></i> Use Query
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function executePredefinedQuery(queryKey, parameters) {
            // If parameters are not provided, get them from form
            if (!parameters) {
                const paramInputs = document.querySelectorAll('#parameterForm input');
                parameters = Array.from(paramInputs).map(input => input.value);
            }

            if (!queryKey) {
                showError('Query key is required');
                return;
            }

            // Validate parameters if required
            const form = document.getElementById('parameterForm');
            if (form && !form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Show loading state
            $('#resultsPanel').show();
            $('#resultsContent').html('<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>');

            $.ajax({
                url: '@Url.Action("Execute", "PredefinedQueries")',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 
                    QueryKey: queryKey,
                    Parameters: parameters || []
                }),
                dataType: 'json',
                success: function(response) {
                    if (response && response.success) {
                        if (response.results && response.results.length > 0) {
                            displayResults(response.results, response.columns);
                        } else {
                            $('#resultsContent').html('<div class="alert alert-info">Query executed successfully. No results returned.</div>');
                        }
                    } else {
                        showError(response?.error || 'An error occurred');
                    }
                },
                error: function(xhr, status, error) {
                    let errorMessage = 'Error executing query: ';
                    console.error('AJAX Error:', { xhr, status, error, responseText: xhr.responseText });
                    
                    if (xhr.status === 404) {
                        errorMessage += 'Endpoint not found. Please check if you are logged in.';
                    } else if (xhr.status === 401 || xhr.status === 403) {
                        errorMessage += 'Unauthorized. Please log in again.';
                    } else if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage += xhr.responseJSON.error;
                    } else if (xhr.responseText) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            errorMessage += response.error || response.message || xhr.responseText.substring(0, 200);
                        } catch {
                            errorMessage += xhr.responseText.substring(0, 200);
                        }
                    } else {
                        errorMessage += error || 'Unknown error (Status: ' + xhr.status + ')';
                    }
                    showError(errorMessage);
                }
            });
        }

        function displayResults(results, columns) {
            if (!results || results.length === 0) {
                $('#resultsContent').html('<div class="alert alert-info">No results found.</div>');
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-striped table-hover table-bordered">';
            
            // Header
            html += '<thead class="table-dark"><tr>';
            columns.forEach(col => {
                html += `<th>${escapeHtml(col)}</th>`;
            });
            html += '</tr></thead>';
            
            // Body
            html += '<tbody>';
            results.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    const value = row[col];
                    const displayValue = value === null || value === undefined || value === 'NULL' ? '<em class="text-muted">NULL</em>' : escapeHtml(String(value));
                    html += `<td>${displayValue}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            
            html += `<div class="mt-2 text-muted"><small>Rows returned: ${results.length}</small></div>`;
            
            $('#resultsContent').html(html);
        }

        function showError(message) {
            $('#resultsPanel').show();
            $('#resultsContent').html(`<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ${escapeHtml(message)}</div>`);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        // Auto-execute if query key and parameters are provided in URL
        $(document).ready(function() {
            const queryKey = '@preFilledQueryKey';
            const parameters = @Html.Raw(Json.Serialize(preFilledParameters));
            
            @if (!string.IsNullOrEmpty(preFilledQueryKey) && Model.ContainsKey(preFilledQueryKey))
            {
                var autoQueryDef = Model[preFilledQueryKey];
                if (!autoQueryDef.RequiresParameters)
                {
                    <text>
                    // Auto-execute if no parameters required
                    if (queryKey) {
                        executePredefinedQuery(queryKey, []);
                    }
                    </text>
                }
                else if (preFilledParameters != null && preFilledParameters.Length > 0)
                {
                    <text>
                    // Auto-execute if parameters already provided
                    if (queryKey && parameters && parameters.length > 0) {
                        executePredefinedQuery(queryKey, parameters);
                    }
                    </text>
                }
            }
        });
    </script>
}

