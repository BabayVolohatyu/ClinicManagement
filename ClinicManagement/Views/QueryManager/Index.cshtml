@{
    ViewData["Title"] = "Query Manager";
}

<div class="row justify-content-center">
    <div class="col-lg-10 col-md-12">
        <h2 class="mb-4">Query Manager</h2>

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-code-square"></i> SQL Query Executor
                </h5>
            </div>
            <div class="card-body">
                
                <div class="mb-3">
                    <label for="queryInput" class="form-label">
                        <i class="bi bi-pencil-square"></i> Enter SQL Query
                    </label>
                    <textarea id="queryInput" class="form-control font-monospace" rows="8" 
                              placeholder="SELECT * FROM &quot;Addresses&quot;;&#10;-- Note: Table names are case-sensitive in PostgreSQL&#10;-- Use quotes for table names: &quot;Addresses&quot;, &quot;People&quot;, etc.&#10;-- Enter your SQL query here...">@(ViewBag.PreFilledQuery ?? string.Empty)</textarea>
                    <small class="form-text text-muted">
                        <i class="bi bi-info-circle"></i> PostgreSQL table names are case-sensitive. Use quotes: <code>"Addresses"</code>, <code>"People"</code>, etc.
                    </small>
                </div>

                
                <div class="mb-3 d-flex gap-2">
                    <button type="button" class="btn btn-primary" onclick="executeQuery()">
                        <i class="bi bi-play-fill"></i> Execute Query
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="clearQuery()">
                        <i class="bi bi-x-circle"></i> Clear
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="showTables()">
                        <i class="bi bi-list-ul"></i> Show Tables
                    </button>
                </div>

                
                <div id="tablesPanel" class="mb-3" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-table"></i> Available Tables
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="tablesContent" class="d-flex flex-wrap gap-2">
                                <span class="text-muted">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>

                
                <div id="resultsPanel" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-table"></i> Results
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="resultsContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function executeQuery() {
            const query = $('#queryInput').val().trim();
            
            if (!query) {
                showError('Please enter a SQL query');
                return;
            }

            
            $('#resultsPanel').show();
            $('#resultsContent').html('<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>');

            $.ajax({
                url: '@Url.Action("Execute", "QueryManager")',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ Query: query }),
                dataType: 'json',
                success: function(response) {
                    if (response && response.success) {
                        if (response.results && response.results.length > 0) {
                            displayResults(response.results, response.columns);
                        } else if (response.message) {
                            $('#resultsContent').html(`<div class="alert alert-success">${escapeHtml(response.message)}</div>`);
                        } else {
                            $('#resultsContent').html('<div class="alert alert-info">Query executed successfully. No results returned.</div>');
                        }
                    } else {
                        showError(response?.error || 'An error occurred');
                    }
                },
                error: function(xhr, status, error) {
                    let errorMessage = 'Error executing query: ';
                    console.error('AJAX Error:', { xhr, status, error, responseText: xhr.responseText });
                    
                    if (xhr.status === 404) {
                        errorMessage += 'Endpoint not found. Please check if you are logged in.';
                    } else if (xhr.status === 401 || xhr.status === 403) {
                        errorMessage += 'Unauthorized. Please log in again.';
                    } else if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage += xhr.responseJSON.error;
                    } else if (xhr.responseText) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            errorMessage += response.error || response.message || xhr.responseText.substring(0, 200);
                        } catch {
                            errorMessage += xhr.responseText.substring(0, 200);
                        }
                    } else {
                        errorMessage += error || 'Unknown error (Status: ' + xhr.status + ')';
                    }
                    showError(errorMessage);
                }
            });
        }

        function displayResults(results, columns) {
            if (!results || results.length === 0) {
                $('#resultsContent').html('<div class="alert alert-info">No results found.</div>');
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-striped table-hover table-bordered">';
            
            
            html += '<thead class="table-dark"><tr>';
            columns.forEach(col => {
                html += `<th>${escapeHtml(col)}</th>`;
            });
            html += '</tr></thead>';
            
            
            html += '<tbody>';
            results.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    const value = row[col];
                    const displayValue = value === null || value === undefined || value === 'NULL' ? '<em class="text-muted">NULL</em>' : escapeHtml(String(value));
                    html += `<td>${displayValue}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            
            html += `<div class="mt-2 text-muted"><small>Rows returned: ${results.length}</small></div>`;
            
            $('#resultsContent').html(html);
        }

        function showError(message) {
            $('#resultsPanel').show();
            $('#resultsContent').html(`<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ${escapeHtml(message)}</div>`);
        }

        function clearQuery() {
            $('#queryInput').val('');
            $('#resultsPanel').hide();
            $('#resultsContent').html('');
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        $('#queryInput').on('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                executeQuery();
            }
        });

        function showTables() {
            $('#tablesPanel').show();
            $('#tablesContent').html('<span class="text-muted">Loading...</span>');

            $.ajax({
                url: '@Url.Action("GetTables", "QueryManager")',
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response && response.tables && response.tables.length > 0) {
                        let html = '';
                        response.tables.forEach(function(table) {
                            const escapedTable = escapeHtml(table);
                            html += `<span class="badge bg-secondary" style="cursor: pointer; font-size: 0.9rem; padding: 6px 12px; margin: 4px;" 
                                     onclick="insertTableName('${escapedTable}')" title="Click to insert table name">"${escapedTable}"</span>`;
                        });
                        $('#tablesContent').html(html);
                    } else {
                        $('#tablesContent').html('<span class="text-muted">No tables found.</span>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading tables:', { xhr, status, error, responseText: xhr.responseText });
                    let errorMsg = 'Error loading tables.';
                    if (xhr.status === 404) {
                        errorMsg += ' Endpoint not found.';
                    } else if (xhr.status === 401 || xhr.status === 403) {
                        errorMsg += ' Unauthorized. Please log in again.';
                    } else if (xhr.responseText) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            errorMsg += ' ' + (response.error || response.message || '');
                        } catch {
                            errorMsg += ' ' + xhr.responseText.substring(0, 100);
                        }
                    }
                    $('#tablesContent').html(`<span class="text-danger">${escapeHtml(errorMsg)}</span>`);
                }
            });
        }

        function insertTableName(tableName) {
            const textarea = $('#queryInput');
            const cursorPos = textarea.prop('selectionStart');
            const textBefore = textarea.val().substring(0, cursorPos);
            const textAfter = textarea.val().substring(cursorPos);
            const quotedName = `"${tableName}"`;
            
            textarea.val(textBefore + quotedName + textAfter);
            textarea.focus();
            textarea.prop('selectionStart', cursorPos + quotedName.length);
            textarea.prop('selectionEnd', cursorPos + quotedName.length);
        }
    </script>
}

