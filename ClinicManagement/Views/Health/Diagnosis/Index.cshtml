@model ClinicManagement.Services.PaginatedResult<ClinicManagement.Models.Health.Diagnosis>

@{
    ViewData["Title"] = "Diagnoses";
    ViewData["Entity"] = ViewContext.RouteData.Values["controller"]?.ToString().ToLower();
    var sortAscending = Model.SortAscending;
    var currentSortBy = Model.SortBy ?? "Id";
}

<div class="row justify-content-center">
    <div class="col-lg-10 col-md-12">
        <h2 class="mb-4">Diagnoses</h2>

        <div class="card mb-4">
            <div class="card-body">
                <form method="get" class="d-flex gap-2 align-items-center">
                    <input type="hidden" name="pageNumber" value="1" />
                    <input type="hidden" name="sortBy" value="@currentSortBy" />
                    <input type="hidden" name="sortAscending" value="@sortAscending.ToString().ToLower()" />

                    <div class="input-group">
                        <input type="text"
                               class="form-control"
                               placeholder="Search..."
                               name="searchTerm"
                               value="@Model.SearchTerm" />
                        <button type="submit" class="btn btn-primary">Search</button>
                        @if (!string.IsNullOrEmpty(Model.SearchTerm))
                        {
                            <a href="@Url.Action("Index", new { pageNumber = 1, pageSize = Model.PageSize })"
                               class="btn btn-outline-secondary">Clear</a>
                        }
                    </div>

                    <select class="form-select" name="pageSize" onchange="this.form.submit()" style="width:auto;">
                        <option value="5" selected="@(Model.PageSize == 5)">5 per page</option>
                        <option value="10" selected="@(Model.PageSize == 10)">10 per page</option>
                        <option value="25" selected="@(Model.PageSize == 25)">25 per page</option>
                        <option value="50" selected="@(Model.PageSize == 50)">50 per page</option>
                    </select>
                </form>
            </div>
        </div>

        @if (!Model.Items.Any())
        {
            <div class="alert alert-info text-center">
                @(string.IsNullOrEmpty(Model.SearchTerm) ? "No diagnoses found." : "No diagnosis matches your search.")
            </div>
        }
        else
        {
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Patient</th>
                                    <th>Doctor</th>
                                    <th>Prescription</th>
                                </tr>
                            </thead>

                            <tbody>
                                @foreach (var item in Model.Items)
                                {
                                    <tr class="clickable-row" data-href="@Url.Action("Entity", new { id = item.Id })">
                                        <td>@item.Id</td>
                                        <td>
                                            @if (item.Appointment != null && item.Appointment.Patient != null && item.Appointment.Patient.Person != null)
                                            {
                                                <a href="@Url.Action("Entity", "Patient", new { id = item.Appointment.Patient.Id })" onclick="event.stopPropagation()">
                                                    @item.Appointment.Patient.Person.LastName, @item.Appointment.Patient.Person.FirstName
                                                </a>
                                            }
                                        </td>
                                        <td>
                                            @if (item.Appointment != null && item.Appointment.DoctorProcedure != null && item.Appointment.DoctorProcedure.Doctor != null && item.Appointment.DoctorProcedure.Doctor.Person != null)
                                            {
                                                <a href="@Url.Action("Entity", "Doctor", new { id = item.Appointment.DoctorProcedure.Doctor.Id })" onclick="event.stopPropagation()">
                                                    @item.Appointment.DoctorProcedure.Doctor.Person.LastName, @item.Appointment.DoctorProcedure.Doctor.Person.FirstName
                                                </a>
                                            }
                                        </td>
                                        <td>@(item.Prescription?.Length > 50 ? item.Prescription.Substring(0, 50) + "..." : item.Prescription)</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-3">
                <small class="text-muted">
                    Showing @((Model.PageNumber - 1) * Model.PageSize + 1) to
                    @Math.Min(Model.PageNumber * Model.PageSize, Model.TotalCount)
                    of @Model.TotalCount entries
                </small>

                <nav>
                    <ul class="pagination mb-0">
                        <li class="page-item @(!Model.HasPrevious ? "disabled" : "")">
                            <a class="page-link"
                               href="@Url.Action("Index", new {
                                   pageNumber = Model.PageNumber - 1,
                                   pageSize = Model.PageSize,
                                   searchTerm = Model.SearchTerm,
                                   sortBy = currentSortBy,
                                   sortAscending = sortAscending
                               })">
                                &laquo;
                            </a>
                        </li>

                        @for (int i = 1; i <= Model.TotalPages; i++)
                        {
                            <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                                <a class="page-link"
                                   href="@Url.Action("Index", new {
                                       pageNumber = i,
                                       pageSize = Model.PageSize,
                                       searchTerm = Model.SearchTerm,
                                       sortBy = currentSortBy,
                                       sortAscending = sortAscending
                                   })">
                                    @i
                                </a>
                            </li>
                        }

                        <li class="page-item @(!Model.HasNext ? "disabled" : "")">
                            <a class="page-link"
                               href="@Url.Action("Index", new {
                                   pageNumber = Model.PageNumber + 1,
                                   pageSize = Model.PageSize,
                                   searchTerm = Model.SearchTerm,
                                   sortBy = currentSortBy,
                                   sortAscending = sortAscending
                               })">
                                &raquo;
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll(".clickable-row").forEach(row => {
                row.addEventListener("click", () => {
                    const url = row.dataset.href;
                    if (url) window.location.href = url;
                });
            });
        });
    </script>
}

